os: linux
dist: focal
language: python

branches:
  only:
  - master

jobs:
  include:
    - name: Linux | arm64 | Python 3.6
      python: 3.6
      arch: arm64
      env: PYTHON=python

    - name: Linux | ppc64le | Python 3.6
      python: 3.6
      arch: ppc64le
      env: PYTHON=python


    - name: Linux | s390x | Python 3.6
      python: 3.6
      arch: s390x
      env: PYTHON=python

before_install: |
  set -eo pipefail
  . /etc/os-release
  echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
  curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/Release.key | sudo apt-key add -
  sudo apt-get update
  sudo apt-get -y install podman
  sudo mkdir -p /etc/containers
  sudo bash -c 'echo -e "[registries.search]\nregistries = [\"docker.io\"]" > /etc/containers/registries.conf'
  mkdir -p ${HOME}/.podman/bin
  ln -s $(which podman) ${HOME}/.podman/bin/docker
  export PATH=${HOME}/.podman/bin:$PATH
  cat /etc/subuid
  cat /etc/subgid
  cat /etc/containers/storage.conf
  mkdir -p ${HOME}/.config/containers
  cat << EOF > ${HOME}/.config/containers/storage.conf
  [storage]
  driver = "overlay"
  [storage.options]
  mount_program = "/usr/bin/fuse-overlayfs"
  EOF
  podman info

install: $PYTHON -m pip install -e ".[dev]" pytest-custom-exit-code

script: $PYTHON ./bin/run_tests.py
