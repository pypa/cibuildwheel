os: linux
dist: focal
language: python

branches:
  only:
  - master

jobs:
  include:
    - name: Linux | arm64 | Python 3.6
      python: 3.6
      arch: arm64
      env: PYTHON=python

    - name: Linux | ppc64le | Python 3.6
      python: 3.6
      arch: ppc64le
      env: PYTHON=python

    - name: Linux | s390x | Python 3.6
      python: 3.6
      arch: s390x
      env: PYTHON=python

before_install: |
  if [ "$(uname -m)" == "ppc64le" ]; then
    # We need to run a rootless docker daemon due to travis-ci LXD configuration
    # Update docker, c.f. https://developer.ibm.com/components/ibm-power/tutorials/install-docker-on-linux-on-power/
    sudo systemctl stop docker
    sudo apt-get update
    sudo apt-get remove -y docker docker.io containerd runc
    sudo apt-get install -y --no-install-recommends containerd uidmap slirp4netns fuse-overlayfs
    curl -fsSLO https://oplab9.parqtec.unicamp.br/pub/ppc64el/docker/version-20.10.6/ubuntu-focal/docker-ce-cli_20.10.6~3-0~ubuntu-focal_ppc64el.deb
    curl -fsSLO https://oplab9.parqtec.unicamp.br/pub/ppc64el/docker/version-20.10.6/ubuntu-focal/docker-ce_20.10.6~3-0~ubuntu-focal_ppc64el.deb
    curl -fsSLO https://oplab9.parqtec.unicamp.br/pub/ppc64el/docker/version-20.10.6/ubuntu-focal/docker-ce-rootless-extras_20.10.6~3-0~ubuntu-focal_ppc64el.deb
    # prevent the docker service to start upon installation
    echo -e '#!/bin/sh\nexit 101' | sudo tee /usr/sbin/policy-rc.d
    sudo chmod +x /usr/sbin/policy-rc.d
    # install docker
    sudo dpkg -i docker-ce-cli_20.10.6~3-0~ubuntu-focal_ppc64el.deb docker-ce-rootless-extras_20.10.6~3-0~ubuntu-focal_ppc64el.deb docker-ce_20.10.6~3-0~ubuntu-focal_ppc64el.deb
    # "restore" policy-rc.d
    sudo rm -f /usr/sbin/policy-rc.d
    # prepare & start the rootless docker daemon
    dockerd-rootless-setuptool.sh install --force
    export XDG_RUNTIME_DIR=/home/travis/.docker/run
    dockerd-rootless.sh &> /dev/null &
    DOCKERD_ROOTLESS_PID=$!
    echo "${DOCKERD_ROOTLESS_PID}" > ${HOME}/dockerd-rootless.pid
    docker context use rootless
  elif [ "$(uname -m)" == "aarch64" ]; then
    # We need to run a rootless docker daemon due to travis-ci LXD configuration
    # Update docker, c.f. https://developer.ibm.com/components/ibm-power/tutorials/install-docker-on-linux-on-power/
    sudo systemctl stop docker
    sudo apt-get update
    sudo apt-get remove -y docker docker.io containerd runc
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    echo "deb [arch=arm64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
    sudo apt-get update
    # prevent the docker service to start upon installation
    echo -e '#!/bin/sh\nexit 101' | sudo tee /usr/sbin/policy-rc.d
    sudo chmod +x /usr/sbin/policy-rc.d
    # install docker
    sudo apt-get install -y --no-install-recommends containerd uidmap slirp4netns fuse-overlayfs docker-ce docker-ce-cli docker-ce-rootless-extras
    # "restore" policy-rc.d
    sudo rm -f /usr/sbin/policy-rc.d
    # prepare & start the rootless docker daemon
    dockerd-rootless-setuptool.sh install --force
    export XDG_RUNTIME_DIR=/home/travis/.docker/run
    dockerd-rootless.sh &> /dev/null &
    DOCKERD_ROOTLESS_PID=$!
    echo "${DOCKERD_ROOTLESS_PID}" > ${HOME}/dockerd-rootless.pid
    docker context use rootless
  fi

install: $PYTHON -m pip install -e ".[dev]" pytest-custom-exit-code

script: $PYTHON ./bin/run_tests.py

after_script: |
  if [ -f ${HOME}/dockerd-rootless.pid ]; then
    kill -15 $(cat ${HOME}/dockerd-rootless.pid);
  fi
  df -h
